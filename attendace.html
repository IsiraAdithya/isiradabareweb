<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitNation Attendance System</title>
   <link rel="icon" type="image/png" href="img/I.png">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .logo span {
            color: #4CAF50;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }
        
        button.danger {
            background-color: #f44336;
        }

        button.danger:hover {
            background-color: #d32f2f;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            position: relative;
        }

        .tab.active {
            background-color: white;
            font-weight: bold;
            border-bottom: 2px solid #4CAF50;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .attendance-table th,
        .attendance-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            white-space: nowrap;
        }
        
        #attendanceData, #paymentHistoryContainer, #memberDetails {
            overflow-x: auto;
        }
        
        #memberDetails .attendance-table tbody tr {
            cursor: pointer;
        }

        #memberDetails .attendance-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .attendance-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }

        .attendance-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .user-detail {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .user-detail h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }

        .info-value {
            font-size: 16px;
        }

        .payment-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-paid {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-unpaid {
            background-color: #ffebee;
            color: #c62828;
        }

        .payment-history {
            margin-top: 20px;
        }

        .payment-history h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Member search styles */
        .member-search-container {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            margin-bottom: 20px;
        }

        .search-input-wrapper {
            position: relative;
            max-width: 400px;
            flex-grow: 1;
        }

        #memberSearch {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        #memberSearch:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-width: 400px;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f5f5f5;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: #333;
        }

        .search-result-id {
            font-size: 14px;
            color: #666;
            margin-top: 2px;
        }

        .search-placeholder {
            color: #999;
            font-style: italic;
            padding: 12px 16px;
        }

        .clear-search {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: none;
        }

        .clear-search:hover {
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-buttons button.cancel {
            background-color: #757575;
        }

        .modal-buttons button.cancel:hover {
            background-color: #616161;
        }

        .update-indicator {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #e8f5e9;
            color: #2e7d32;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-5px);
        }

        .update-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .connection-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        }

        .connection-status.connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .connection-status.disconnected {
            background-color: #ffebee;
            color: #c62828;
        }

        .retry-button {
            display: block;
            margin: 15px auto;
            padding: 8px 15px;
        }

        /* Edit form styles */
        .edit-form {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="connectionStatus" class="connection-status"></div>
        <header>
            <div class="logo">Fit<span>Nation</span> Attendance</div>
            <div class="date-selector">
                <input type="date" id="dateSelector">
                <button id="viewButton">View Attendance</button>
            </div>
        </header>
        <div class="tabs">
            <div class="tab active" data-tab="attendance">Attendance <span id="attendanceUpdateIndicator" class="update-indicator"></span></div>
            <div class="tab" data-tab="members">Member Management <span id="membersUpdateIndicator" class="update-indicator"></span></div>
        </div>
        <div id="attendanceTab" class="content active">
            <h2>Daily Attendance - <span id="selectedDate"></span></h2>
            <div id="attendanceData" class="loading">Loading attendance data...</div>
        </div>
        <div id="membersTab" class="content">
            <h2>Member Management</h2>
            <div class="member-search-container">
                <div class="search-input-wrapper">
                    <input type="text" id="memberSearch" placeholder="Search members by name or ID...">
                    <button type="button" class="clear-search" id="clearSearch">&times;</button>
                    <div id="searchResults" class="search-results"></div>
                </div>
                <button id="showAllMembersBtn">Show All</button>
            </div>
            <div id="memberDetails">
                <div class="no-data">Select a member to view their details.</div>
            </div>
        </div>
    </div>
    
    <!-- Payment Confirmation Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Payment</h3>
            <p>Are you sure you want to record a payment for this member?</p>
            <div class="modal-buttons">
                <button id="confirmPayment">Confirm Payment</button>
                <button class="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Unpaid Confirmation Modal -->
    <div id="unpaidModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Status Change</h3>
            <p>Are you sure you want to mark this member as Unpaid? This will reverse the last payment record.</p>
            <div class="modal-buttons">
                <button id="confirmUnpaid" class="danger">Mark as Unpaid</button>
                <button class="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <h3>Edit Member Details</h3>
            <div id="editMemberFormContainer">
                <!-- Form will be dynamically inserted here -->
            </div>
            <div class="modal-buttons">
                <button id="saveChanges">Save Changes</button>
                <button class="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase connection status element
        const connectionStatus = document.getElementById('connectionStatus');

        // Initialize Firebase with error handling
        let db;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyBqXSXTvFepSC7Pk4e-6C7lsEN1T2ZUqsQ",
                authDomain: "javazz-fitness.firebaseapp.com",
                databaseURL: "https://javazz-fitness-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "javazz-fitness",
                storageBucket: "javazz-fitness.appspot.com",
                messagingSenderId: "537542310571",
                appId: "1:537542310571:web:fa820363ffb1c6d15c95ee"
            };
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.database();

            // Monitor connection state
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                const retryBtn = document.getElementById('retryConnection');
                if (snap && snap.val() === true) {
                    connectionStatus.textContent = "Connected to Database";
                    connectionStatus.className = "connection-status connected";
                    if (retryBtn) retryBtn.remove();
                } else {
                    connectionStatus.textContent = "Disconnected from Database";
                    connectionStatus.className = "connection-status disconnected";
                    if (!retryBtn) {
                        const newRetryBtn = document.createElement('button');
                        newRetryBtn.id = 'retryConnection';
                        newRetryBtn.className = 'retry-button';
                        newRetryBtn.textContent = 'Retry Connection';
                        newRetryBtn.addEventListener('click', () => window.location.reload());
                        connectionStatus.appendChild(newRetryBtn);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization error:", error);
            connectionStatus.textContent = "Failed to initialize Firebase: " + error.message;
            connectionStatus.className = "connection-status disconnected";
        }

        // DOM Elements
        const dateSelector = document.getElementById('dateSelector');
        const viewButton = document.getElementById('viewButton');
        const selectedDateEl = document.getElementById('selectedDate');
        const attendanceData = document.getElementById('attendanceData');
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.content');
        const memberSearch = document.getElementById('memberSearch');
        const searchResults = document.getElementById('searchResults');
        const clearSearch = document.getElementById('clearSearch');
        const showAllMembersBtn = document.getElementById('showAllMembersBtn');
        const memberDetails = document.getElementById('memberDetails');
        
        const paymentModal = document.getElementById('paymentModal');
        const confirmPaymentBtn = document.getElementById('confirmPayment');
        
        const unpaidModal = document.getElementById('unpaidModal');
        const confirmUnpaidBtn = document.getElementById('confirmUnpaid');
        
        const editMemberModal = document.getElementById('editMemberModal');
        const editMemberFormContainer = document.getElementById('editMemberFormContainer');
        const saveChangesBtn = document.getElementById('saveChanges');
        
        const attendanceUpdateIndicator = document.getElementById('attendanceUpdateIndicator');
        const membersUpdateIndicator = document.getElementById('membersUpdateIndicator');

        // Variables to store active listeners
        let activeAttendanceListener = null;
        let activeMembersListener = null;
        let activeSingleMemberListener = null;
        let activePaymentListener = null;

        // Global object to store user data
        let userGymIds = {};
        let allMembersData = {};
        let currentSelectedMemberId = null;

        // Set default date to today
        const today = new Date();
        const formattedToday = today.toISOString().substr(0, 10);
        dateSelector.value = formattedToday;

        // Event Listeners
        viewButton.addEventListener('click', setupAttendanceListener);

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                contents.forEach(c => c.classList.remove('active'));
                document.getElementById(tabId + 'Tab').classList.add('active');
                if (tabId === 'attendance') {
                    setupAttendanceListener();
                } else if (tabId === 'members') {
                    setupMembersListener();
                }
            });
        });

        memberSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            clearSearch.style.display = searchTerm.length > 0 ? 'block' : 'none';
            if (searchTerm.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            const filteredMembers = Object.keys(allMembersData).filter(memberId => {
                const member = allMembersData[memberId];
                if (!member) return false;
                return (member.Name || '').toLowerCase().includes(searchTerm) ||
                       (member.Gym_ID || '').toLowerCase().includes(searchTerm) ||
                       memberId.toLowerCase().includes(searchTerm);
            });
            displaySearchResults(filteredMembers);
        });

        clearSearch.addEventListener('click', () => {
            memberSearch.value = '';
            searchResults.style.display = 'none';
            clearSearch.style.display = 'none';
            memberDetails.innerHTML = '<div class="no-data">Select a member to view their details.</div>';
            currentSelectedMemberId = null;
            if(activeSingleMemberListener) activeSingleMemberListener();
            memberSearch.focus();
        });

        showAllMembersBtn.addEventListener('click', () => {
            memberSearch.value = '';
            searchResults.style.display = 'none';
            clearSearch.style.display = 'none';
            displayAllMembersTable();
        });

        document.addEventListener('click', (event) => {
            if (!event.target.closest('.search-input-wrapper')) {
                searchResults.style.display = 'none';
            }
        });
        
        // Modal general close buttons
        document.querySelectorAll('.modal .cancel').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').style.display = 'none';
            });
        });
        
        confirmPaymentBtn.addEventListener('click', processPayment);
        confirmUnpaidBtn.addEventListener('click', processUnpaid);
        saveChangesBtn.addEventListener('click', saveUserChanges);
        
        // Initial data load
        loadInitialData();

        function loadInitialData() {
            loadUserData().then(() => {
                setupAttendanceListener();
                setupMembersListener();
            }).catch(err => {
                console.error("Initial data load failed:", err);
            });
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function showUpdateIndicator(indicator) {
            indicator.textContent = 'Updated';
            indicator.classList.add('visible');
            setTimeout(() => indicator.classList.remove('visible'), 3000);
        }

        function loadUserData() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error("Firebase not initialized"));
                db.ref('Users').once('value').then(snapshot => {
                    const data = snapshot.val() || {};
                    userGymIds = {};
                    Object.keys(data).forEach(userId => {
                        if (data[userId]) {
                            userGymIds[userId] = data[userId].Gym_ID || 'N/A';
                        }
                    });
                    resolve();
                }).catch(error => {
                    console.error("Error loading user data:", error);
                    reject(error);
                });
            });
        }

        function setupAttendanceListener() {
            if (!db) {
                attendanceData.innerHTML = '<div class="no-data">Database not connected.</div>';
                return;
            }
            if (activeAttendanceListener) activeAttendanceListener();
            
            const selectedDate = dateSelector.value;
            selectedDateEl.textContent = new Date(selectedDate + 'T00:00:00').toDateString();
            attendanceData.innerHTML = '<div class="loading">Loading attendance data...</div>';

            loadUserData().then(() => {
                const attendanceRef = db.ref('Attendance/' + selectedDate);
                activeAttendanceListener = attendanceRef.on('value', snapshot => {
                    if (snapshot) {
                        updateAttendanceDisplay(snapshot.val());
                        showUpdateIndicator(attendanceUpdateIndicator);
                    }
                }, error => {
                    console.error("Error loading attendance data:", error);
                    attendanceData.innerHTML = `<div class="no-data">Error: ${error.message}</div>`;
                });
            }).catch(error => {
                 attendanceData.innerHTML = `<div class="no-data">Error loading user data: ${error.message}</div>`;
            });
        }

        function updateAttendanceDisplay(data) {
            if (!data) {
                attendanceData.innerHTML = '<div class="no-data">No attendance records for this date.</div>';
                return;
            }
            let attendanceEntries = [];
            Object.keys(data).forEach(memberId => {
                const memberData = data[memberId];
                if (!memberData) return;
                const sessionCount = memberData.SessionCount || 0;
                for (let i = 1; i <= sessionCount; i++) {
                    const session = memberData[`Session${i}`];
                    if (!session) continue;
                    
                    let checkInTime = session.Logged_in_Time || '-';
                    let checkOutTime = session.Logged_out_Time || '-';

                    attendanceEntries.push({
                        name: session.Name || '-',
                        gymId: userGymIds[memberId] || 'N/A',
                        checkInTime: checkInTime !== '-' ? new Date(checkInTime).toLocaleTimeString() : '-',
                        checkInTimeForSort: checkInTime,
                        checkOutTime: checkOutTime !== '-' ? new Date(checkOutTime).toLocaleTimeString() : '-',
                        paymentStatus: session.Payment_Status || '-'
                    });
                }
            });

            attendanceEntries.sort((a, b) => new Date(a.checkInTimeForSort) - new Date(b.checkInTimeForSort));

            let tableHTML = `
                <table class="attendance-table">
                    <thead>
                        <tr><th>#</th><th>Name</th><th>Gym ID</th><th>Check-in</th><th>Check-out</th><th>Payment Status</th></tr>
                    </thead>
                    <tbody>`;
            attendanceEntries.forEach((entry, index) => {
                const statusClass = entry.paymentStatus.toLowerCase() === 'paid' ? 'status-paid' : 'status-unpaid';
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${entry.name}</td>
                        <td>${entry.gymId}</td>
                        <td>${entry.checkInTime}</td>
                        <td>${entry.checkOutTime}</td>
                        <td><span class="payment-status ${statusClass}">${entry.paymentStatus}</span></td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            attendanceData.innerHTML = tableHTML;
        }

        function setupMembersListener() {
            if (!db) return;
            if (activeMembersListener) activeMembersListener();
            const usersRef = db.ref('Users');
            activeMembersListener = usersRef.on('value', snapshot => {
                if (snapshot) {
                    allMembersData = snapshot.val() || {};
                    Object.keys(allMembersData).forEach(userId => {
                         if(allMembersData[userId]) {
                            userGymIds[userId] = allMembersData[userId].Gym_ID || 'N/A';
                         }
                    });
                    if (currentSelectedMemberId && allMembersData[currentSelectedMemberId]) {
                       setupMemberDetailsListener(currentSelectedMemberId);
                    }
                    showUpdateIndicator(membersUpdateIndicator);
                }
            }, error => console.error("Error loading members:", error));
        }

        function displaySearchResults(memberIds) {
            searchResults.innerHTML = '';
            if (memberIds.length === 0) {
                searchResults.innerHTML = '<div class="search-placeholder">No members found</div>';
            } else {
                memberIds.sort((a,b) => (allMembersData[a]?.Name || '').localeCompare(allMembersData[b]?.Name || ''))
                    .forEach(memberId => {
                    const member = allMembersData[memberId];
                    if (!member) return;
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `<div class="search-result-name">${member.Name || 'Unknown'}</div><div class="search-result-id">ID: ${memberId} | Gym ID: ${member.Gym_ID || 'N/A'}</div>`;
                    resultItem.addEventListener('click', () => selectMember(memberId));
                    searchResults.appendChild(resultItem);
                });
            }
            searchResults.style.display = 'block';
        }

        function displayAllMembersTable() {
            memberDetails.innerHTML = ''; // Clear the details section
            const table = document.createElement('table');
            table.className = 'attendance-table'; 

            let tableHTML = `
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Gym ID</th>
                    </tr>
                </thead>
                <tbody>
            `;

            const sortedMemberIds = Object.keys(allMembersData).sort((a, b) => (allMembersData[a]?.Name || '').localeCompare(allMembersData[b]?.Name || ''));

            sortedMemberIds.forEach(memberId => {
                const member = allMembersData[memberId];
                if (member) {
                    tableHTML += `
                        <tr data-id="${memberId}">
                            <td>${member.Name || 'N/A'}</td>
                            <td>${member.Gym_ID || 'N/A'}</td>
                        </tr>
                    `;
                }
            });
            
            tableHTML += `</tbody>`;
            table.innerHTML = tableHTML;
            
            table.addEventListener('click', (event) => {
                const row = event.target.closest('tr');
                if (row && row.dataset.id) {
                    selectMember(row.dataset.id);
                }
            });

            memberDetails.appendChild(table);
        }

        function selectMember(memberId) {
            currentSelectedMemberId = memberId;
            const memberName = allMembersData[memberId]?.Name || 'Unknown';
            memberSearch.value = `${memberId}: ${memberName}`;
            searchResults.style.display = 'none';
            clearSearch.style.display = 'block';
            setupMemberDetailsListener(memberId);
        }
        
        function setupMemberDetailsListener(memberId) {
            if (!db) return;
            if (activeSingleMemberListener) activeSingleMemberListener();
            
            memberDetails.innerHTML = '<div class="loading">Loading member details...</div>';
            const memberRef = db.ref('Users/' + memberId);
             
            activeSingleMemberListener = memberRef.on('value', snapshot => {
                 if (snapshot && snapshot.exists()) {
                     const memberData = snapshot.val();
                     updateMemberDetailsDisplay(memberId, memberData);
                     setupPaymentHistoryListener(memberId);
                 } else {
                    memberDetails.innerHTML = `<div class="no-data">Member with ID ${memberId} not found.</div>`;
                 }
            }, error => {
                console.error(`Error loading details for member ${memberId}:`, error);
                memberDetails.innerHTML = `<div class="no-data">Error loading details.</div>`;
            });
        }
        
        function updateMemberDetailsDisplay(memberId, userData) {
            const isPaid = (userData.Payment_Status || '').toLowerCase() === 'paid';
            let actionButtonHTML = '';

            if (isPaid) {
                actionButtonHTML = `<button id="unpaidMemberBtn" class="danger">Mark as Unpaid</button>`;
            } else {
                actionButtonHTML = `<button id="recordPaymentBtn">Make Payment</button>`;
            }

            let detailsHTML = `
                <div class="user-detail">
                    <h3>${userData.Name || 'N/A'} - Details</h3>
                    <div class="user-info">
                        <div class="info-item"><span class="info-label">Member ID:</span><span class="info-value">${memberId}</span></div>
                        <div class="info-item"><span class="info-label">Gym ID:</span><span class="info-value">${userData.Gym_ID || 'N/A'}</span></div>
                        <div class="info-item"><span class="info-label">Phone:</span><span class="info-value">${userData.Phone_Number || 'N/A'}</span></div>
                        <div class="info-item"><span class="info-label">Last Payment:</span><span class="info-value">${formatDate(userData.Last_Payment_Date)}</span></div>
                        <div class="info-item"><span class="info-label">Payment Status:</span><span class="info-value"><span class="payment-status ${isPaid ? 'status-paid' : 'status-unpaid'}">${userData.Payment_Status || 'N/A'}</span></span></div>
                    </div>
                    <div class="action-buttons">
                        ${actionButtonHTML}
                        <button id="editMemberBtn">Edit Details</button>
                    </div>
                </div>
                <div id="paymentHistorySection" class="payment-history user-detail">
                    <h4>Payment History</h4>
                    <div id="paymentHistoryContainer"><div class="loading">Loading history...</div></div>
                </div>
            `;
            memberDetails.innerHTML = detailsHTML;
            
            if (isPaid) {
                document.getElementById('unpaidMemberBtn').addEventListener('click', () => openUnpaidModal(memberId, userData.Last_Payment_Date));
            } else {
                document.getElementById('recordPaymentBtn').addEventListener('click', () => openPaymentModal(memberId));
            }
            document.getElementById('editMemberBtn').addEventListener('click', () => openEditModal(memberId, userData));
        }
        
        function setupPaymentHistoryListener(memberId) {
            if (!db) return;
            if(activePaymentListener) activePaymentListener();
            
            const historyRef = db.ref(`paymentTable/${memberId}`);
            activePaymentListener = historyRef.on('value', snapshot => {
                if (snapshot && snapshot.exists()) {
                    updatePaymentHistoryDisplay(snapshot.val());
                } else {
                    updatePaymentHistoryDisplay(null);
                }
            }, error => {
                console.error("Error loading payment history:", error);
                const container = document.getElementById('paymentHistoryContainer');
                if (container) {
                    container.innerHTML = '<div class="no-data">Error loading history.</div>';
                }
            });
        }
        
        function updatePaymentHistoryDisplay(historyData) {
            const container = document.getElementById('paymentHistoryContainer');
            if (!container) return; 
            
            if (!historyData) {
                container.innerHTML = '<div class="no-data">No payment history found.</div>';
                return;
            }

            let historyHTML = `
                <table class="attendance-table">
                    <thead><tr><th>Payment Date</th><th>Status</th></tr></thead>
                    <tbody>`;
            const sortedKeys = Object.keys(historyData).sort().reverse();
            sortedKeys.forEach(key => {
                const entry = historyData[key];
                if (!entry) return;
                const statusClass = (entry.Status || '').toLowerCase() === 'paid' ? 'status-paid' : 'status-unpaid';
                historyHTML += `
                    <tr>
                        <td>${formatDate(entry.Date)}</td>
                        <td><span class="payment-status ${statusClass}">${entry.Status || 'N/A'}</span></td>
                    </tr>`;
            });
            historyHTML += `</tbody></table>`;
            container.innerHTML = historyHTML;
        }

        function openPaymentModal(memberId) {
            confirmPaymentBtn.setAttribute('data-id', memberId);
            paymentModal.style.display = 'flex';
        }

        function openUnpaidModal(memberId, lastPaymentDate) {
            confirmUnpaidBtn.setAttribute('data-id', memberId);
            confirmUnpaidBtn.setAttribute('data-last-payment', lastPaymentDate);
            unpaidModal.style.display = 'flex';
        }

        function processPayment() {
            const memberId = confirmPaymentBtn.getAttribute('data-id');
            if (!memberId || !db) return;
            
            const paymentDate = new Date().toISOString().split('T')[0];
            
            const userUpdates = {
                'Payment_Status': 'Paid',
                'Last_Payment_Date': paymentDate
            };
            db.ref('Users/' + memberId).update(userUpdates)
            .then(() => {
                const paymentRecord = {
                    Amount: "500.00",
                    Date: paymentDate,
                    Status: "Paid"
                };
                return db.ref(`paymentTable/${memberId}/${paymentDate}`).set(paymentRecord);
            })
            .then(() => {
                console.log("Payment recorded successfully.");
                paymentModal.style.display = 'none';
            })
            .catch(error => {
                console.error("Payment recording failed:", error);
                alert("Failed to record payment. Please try again.");
            });
        }

        function processUnpaid() {
            const memberId = confirmUnpaidBtn.getAttribute('data-id');
            const lastPaymentDate = confirmUnpaidBtn.getAttribute('data-last-payment');
            if (!memberId || !db) return;

            const userUpdates = {
                'Payment_Status': 'Unpaid',
                'Last_Payment_Date': '' // Clear the last payment date
            };

            db.ref('Users/' + memberId).update(userUpdates)
            .then(() => {
                console.log("User status updated to Unpaid.");
                // If there's a last payment date, remove that record from paymentTable
                if (lastPaymentDate) {
                    return db.ref(`paymentTable/${memberId}/${lastPaymentDate}`).remove();
                }
            })
            .then(() => {
                console.log("Last payment record removed successfully.");
                unpaidModal.style.display = 'none';
            })
            .catch(error => {
                console.error("Failed to mark as unpaid:", error);
                alert("Failed to update status. Please try again.");
            });
        }
        
        function openEditModal(memberId, data) {
            currentSelectedMemberId = memberId;
            const formHTML = `
                <div class="edit-form">
                    <div class="form-group">
                        <label for="editName">Name</label>
                        <input type="text" id="editName" value="${data.Name || ''}">
                    </div>
                    <div class="form-group">
                        <label for="editGymId">Gym ID</label>
                        <input type="text" id="editGymId" value="${data.Gym_ID || ''}">
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Phone Number</label>
                        <input type="text" id="editPhone" value="${data.Phone_Number || ''}">
                    </div>
                </div>`;
            editMemberFormContainer.innerHTML = formHTML;
            editMemberModal.style.display = 'flex';
        }
        
        function saveUserChanges() {
            if (!currentSelectedMemberId || !db) return;
            
            const updates = {
                Name: document.getElementById('editName').value,
                Gym_ID: document.getElementById('editGymId').value,
                Phone_Number: document.getElementById('editPhone').value,
            };

            db.ref('Users/' + currentSelectedMemberId).update(updates)
                .then(() => {
                    console.log('Member details updated');
                    editMemberModal.style.display = 'none';
                })
                .catch(error => {
                    console.error("Update failed:", error);
                    alert("Failed to update details. Please try again.");
                });
        }
    </script>
</body>
</html>
