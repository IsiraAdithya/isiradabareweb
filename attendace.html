<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitNation Attendance System</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }

        .logo span {
            color: #4CAF50;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }

        .tab.active {
            background-color: white;
            font-weight: bold;
            border-bottom: 2px solid #4CAF50;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .attendance-table th,
        .attendance-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .attendance-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }

        .attendance-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .user-detail {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .user-detail h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
        }

        .payment-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-paid {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-unpaid {
            background-color: #ffebee;
            color: #c62828;
        }

        .payment-history {
            margin-top: 20px;
        }

        .payment-history h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        #memberSelector {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal h3 {
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-buttons button.cancel {
            background-color: #f44336;
        }

        .modal-buttons button.cancel:hover {
            background-color: #d32f2f;
        }

        .update-indicator {
            display: inline-block;
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #e8f5e9;
            color: #2e7d32;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .update-indicator.visible {
            opacity: 1;
        }

        .connection-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        }

        .connection-status.connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .connection-status.disconnected {
            background-color: #ffebee;
            color: #c62828;
        }

        .retry-button {
            display: block;
            margin: 15px auto;
            padding: 8px 15px;
        }

        /* Edit form styles */
        .edit-form {
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="connectionStatus" class="connection-status"></div>
        
        <header>
            <div class="logo">Fit<span>Nation</span> Attendance <span id="attendanceUpdateIndicator" class="update-indicator">Updated</span></div>
            <div class="date-selector">
                <input type="date" id="dateSelector">
                <button id="viewButton">View Attendance</button>
                <button id="newUserButton" onclick="window.location.href='login.html'">New User</button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="attendance">Attendance</div>
            <div class="tab" data-tab="members">Member Management <span id="membersUpdateIndicator" class="update-indicator">Updated</span></div>
        </div>

        <div id="attendanceTab" class="content active">
            <h2>Daily Attendance - <span id="selectedDate"></span></h2>
            <div id="attendanceData" class="loading">Loading attendance data...</div>
        </div>

        <div id="membersTab" class="content">
            <h2>Member Management</h2>
            <select id="memberSelector">
                <option value="">Select a member</option>
            </select>

            <div id="memberDetails"></div>
        </div>
    </div>

    <!-- Payment Confirmation Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Payment</h3>
            <p>Are you sure you want to record a payment for this member?</p>
            <p>This will update their payment status to "Paid" and record today's date.</p>
            <div class="modal-buttons">
                <button id="confirmPayment">Confirm Payment</button>
                <button id="cancelPayment" class="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <h3>Edit Member Details</h3>
            <div id="editMemberForm" class="edit-form">
                <!-- Form fields will be added here dynamically -->
            </div>
            <div class="modal-buttons">
                <button id="saveChanges">Save Changes</button>
                <button id="cancelEdit" class="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase connection status element
        const connectionStatus = document.getElementById('connectionStatus');
        
        // Initialize Firebase with error handling
        let db;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyBqXSXTvFepSC7Pk4e-6C7lsEN1T2ZUqsQ",
                authDomain: "javazz-fitness.firebaseapp.com",
                databaseURL: "https://javazz-fitness-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "javazz-fitness",
                storageBucket: "javazz-fitness.firebasestorage.app",
                messagingSenderId: "537542310571",
                appId: "1:537542310571:web:fa820363ffb1c6d15c95ee"
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            db = firebase.database();
            
            // Monitor connection state
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap && snap.val() === true) {
                    connectionStatus.textContent = "Connected to Firebase";
                    connectionStatus.className = "connection-status connected";
                } else {
                    connectionStatus.textContent = "Disconnected from Firebase";
                    connectionStatus.className = "connection-status disconnected";
                    
                    // Add retry button if disconnected
                    if (!document.getElementById('retryConnection')) {
                        const retryBtn = document.createElement('button');
                        retryBtn.id = 'retryConnection';
                        retryBtn.className = 'retry-button';
                        retryBtn.textContent = 'Retry Connection';
                        retryBtn.addEventListener('click', function() {
                            window.location.reload();
                        });
                        connectionStatus.appendChild(retryBtn);
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization error:", error);
            connectionStatus.textContent = "Failed to initialize Firebase: " + error.message;
            connectionStatus.className = "connection-status disconnected";
        }

        // DOM Elements
        const dateSelector = document.getElementById('dateSelector');
        const viewButton = document.getElementById('viewButton');
        const selectedDateEl = document.getElementById('selectedDate');
        const attendanceData = document.getElementById('attendanceData');
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.content');
        const memberSelector = document.getElementById('memberSelector');
        const memberDetails = document.getElementById('memberDetails');
        const paymentModal = document.getElementById('paymentModal');
        const confirmPaymentBtn = document.getElementById('confirmPayment');
        const cancelPaymentBtn = document.getElementById('cancelPayment');
        const attendanceUpdateIndicator = document.getElementById('attendanceUpdateIndicator');
        const membersUpdateIndicator = document.getElementById('membersUpdateIndicator');
        const editMemberModal = document.getElementById('editMemberModal');
        const editMemberForm = document.getElementById('editMemberForm');
        const saveChangesBtn = document.getElementById('saveChanges');
        const cancelEditBtn = document.getElementById('cancelEdit');

        // Variables to store active listeners
        let activeAttendanceListener = null;
        let activeMemberListener = null;
        let activePaymentListener = null;
        // Global object to store user gym IDs for attendance view
        let userGymIds = {};

        // Set default date to today
        const today = new Date();
        const formattedToday = today.toISOString().substr(0, 10);
        dateSelector.value = formattedToday;
        selectedDateEl.textContent = formatDate(formattedToday);

        // Event Listeners
        viewButton.addEventListener('click', () => {
            setupAttendanceListener();
        });

        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');

                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update active content
                contents.forEach(c => c.classList.remove('active'));
                document.getElementById(tabId + 'Tab').classList.add('active');

                // Load appropriate data and set listeners
                if (tabId === 'attendance') {
                    setupAttendanceListener();
                } else if (tabId === 'members') {
                    setupMembersListener();
                }
            });
        });

        // Member selector event
        memberSelector.addEventListener('change', function () {
            const selectedId = this.value;
            if (selectedId) {
                setupMemberDetailsListener(selectedId);
            } else {
                memberDetails.innerHTML = '';
                // Remove previous member listener if any
                if (activeMemberListener) {
                    activeMemberListener();
                    activeMemberListener = null;
                }
                if (activePaymentListener) {
                    activePaymentListener();
                    activePaymentListener = null;
                }
            }
        });

        // Payment modal events
        confirmPaymentBtn.addEventListener('click', processPayment);
        cancelPaymentBtn.addEventListener('click', () => {
            paymentModal.style.display = 'none';
        });

        // Edit Member Modal events
        saveChangesBtn.addEventListener('click', saveUserChanges);
        cancelEditBtn.addEventListener('click', () => {
            editMemberModal.style.display = 'none';
        });

        // Initial data load with listeners
        // First, load all user data to get Gym IDs
        loadUserData().then(() => {
            setupAttendanceListener();
        });

        // Function to load all user data
        function loadUserData() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    console.error("Firebase not initialized");
                    reject(new Error("Firebase not initialized"));
                    return;
                }

                const usersRef = db.ref('Users');
                usersRef.once('value')
                    .then(snapshot => {
                        if (snapshot) {
                            const data = snapshot.val() || {};
                            userGymIds = {}; // Reset the user gym IDs
                            
                            // Store gym IDs for all users
                            Object.keys(data).forEach(userId => {
                                const userData = data[userId];
                                if (userData) {
                                    userGymIds[userId] = userData.Gym_ID || 'N/A';
                                }
                            });
                            
                            resolve();
                        } else {
                            resolve(); // Still resolve even if no data
                        }
                    })
                    .catch(error => {
                        console.error("Error loading user data:", error);
                        reject(error);
                    });
            });
        }

        // Show update indicator
        function showUpdateIndicator(indicator) {
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 3000);
        }

        // Functions for real-time updates
        function setupAttendanceListener() {
            // Check if Firebase is initialized
            if (!db) {
                attendanceData.innerHTML = '<div class="no-data">Firebase not initialized. Please refresh the page and try again.</div>';
                return;
            }
            
            // Remove previous listener if exists
            if (activeAttendanceListener) {
                activeAttendanceListener();
                activeAttendanceListener = null;
            }

            const selectedDate = dateSelector.value;
            selectedDateEl.textContent = formatDate(selectedDate);

            attendanceData.innerHTML = '<div class="loading">Loading attendance data...</div>';

            // Convert selected date to format used in Firebase (YYYY-MM-DD)
            const dateFormatted = selectedDate;

            // Reload user data to ensure we have latest Gym IDs
            loadUserData().then(() => {
                try {
                    // Reference to attendance data for the selected date
                    const attendanceRef = db.ref('Attendance/' + dateFormatted);
                    
                    // Set up a real-time listener with safe error handling
                    activeAttendanceListener = attendanceRef.on('value', 
                        (snapshot) => {
                            if (snapshot) {
                                const data = snapshot.val();
                                updateAttendanceDisplay(data);
                                showUpdateIndicator(attendanceUpdateIndicator);
                            } else {
                                attendanceData.innerHTML = '<div class="no-data">No data available or connection issue.</div>';
                            }
                        }, 
                        (error) => {
                            console.error("Error loading attendance data:", error);
                            attendanceData.innerHTML = `<div class="no-data">Error loading attendance data: ${error.message}</div>`;
                        }
                    );
                } catch (error) {
                    console.error("Error setting up attendance listener:", error);
                    attendanceData.innerHTML = `<div class="no-data">Error setting up data listener: ${error.message}</div>`;
                    activeAttendanceListener = null;
                }
            }).catch(error => {
                console.error("Error reloading user data:", error);
                attendanceData.innerHTML = `<div class="no-data">Error loading user data: ${error.message}</div>`;
            });
        }

        function updateAttendanceDisplay(data) {
            if (!data) {
                attendanceData.innerHTML = '<div class="no-data">No attendance records for this date.</div>';
                return;
            }

            let tableHTML = `
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Gym ID</th>
                            <th>Name</th>
                            <th>Check-in Time</th>
                            <th>Check-out Time</th>
                            <th>Payment Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Create an array to hold all attendance entries for sorting
            let attendanceEntries = [];

            Object.keys(data).forEach(memberId => {
                const memberData = data[memberId];
                const sessionCount = memberData.SessionCount || 0;

                for (let i = 1; i <= sessionCount; i++) {
                    const session = memberData[`Session${i}`];
                    if (!session) continue;

                    // Extract only time from check-in time
                    let checkInTime = session.Logged_in_Time || '-';
                    let checkInTimeForSort = checkInTime; // Keep original for sorting
                    if (checkInTime !== '-') {
                        const timeParts = checkInTime.split(' ');
                        if (timeParts.length > 1) {
                            checkInTime = timeParts[1]; // Get only the time part
                        }
                    }

                    // Extract only time from check-out time
                    let checkOutTime = session.Logged_out_Time || '-';
                    if (checkOutTime !== '-') {
                        const timeParts = checkOutTime.split(' ');
                        if (timeParts.length > 1) {
                            checkOutTime = timeParts[1]; // Get only the time part
                        }
                    }

                    const name = session.Name || '-';
                    const paymentStatus = session.Payment_Status || '-';
                    // Get Gym ID from our cached user data
                    const gymId = userGymIds[memberId] || 'N/A';

                    attendanceEntries.push({
                        memberId,
                        gymId,
                        name,
                        checkInTime,
                        checkInTimeForSort,
                        checkOutTime,
                        paymentStatus
                    });
                }
            });

            // Sort attendance entries by check-in time
            attendanceEntries.sort((a, b) => {
                // If either check-in time is "-", handle accordingly
                if (a.checkInTimeForSort === '-') return -1;
                if (b.checkInTimeForSort === '-') return 1;
                
                // Otherwise, compare the original timestamps
                return new Date(a.checkInTimeForSort) - new Date(b.checkInTimeForSort);
            });

            // Add sorted entries to the table
            attendanceEntries.forEach((entry ,index)=> {
                const rowNumbers = index +1;
                const statusClass = entry.paymentStatus.toLowerCase() === 'paid' ? 'status-paid' : 'status-unpaid';

                tableHTML += `
                    <tr>
                        <td>${rowNumbers}</td>
                        <td>${entry.gymId}</td>
                        <td>${entry.name}</td>
                        <td>${entry.checkInTime}</td>
                        <td>${entry.checkOutTime}</td>
                        <td><span class="payment-status ${statusClass}">${entry.paymentStatus}</span></td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            attendanceData.innerHTML = tableHTML;
        }

        function setupMembersListener() {
            // Check if Firebase is initialized
            if (!db) {
                memberDetails.innerHTML = '<div class="no-data">Firebase not initialized. Please refresh the page and try again.</div>';
                return;
            }
            
            // Clear previous options except the default one
            while (memberSelector.options.length > 1) {
                memberSelector.remove(1);
            }

            memberDetails.innerHTML = '';

            try {
                // Reference to all users
                const usersRef = db.ref('Users');

                // Remove existing listener if any
                if (activeMemberListener) {
                    activeMemberListener();
                    activeMemberListener = null;
                }

                // Set up new real-time listener for member list
                usersRef.on('value', 
                    (snapshot) => {
                        if (snapshot) {
                            const data = snapshot.val();
                            updateMembersSelector(data);
                            // Update our cached user data
                            if (data) {
                                Object.keys(data).forEach(userId => {
                                    const userData = data[userId];
                                    if (userData) {
                                        userGymIds[userId] = userData.Gym_ID || 'N/A';
                                    }
                                });
                            }
                            showUpdateIndicator(membersUpdateIndicator);
                        } else {
                            memberSelector.innerHTML = '<option value="">No members available</option>';
                        }
                    }, 
                    (error) => {
                        console.error("Error loading members:", error);
                        memberSelector.innerHTML = '<option value="">Error loading members</option>';
                    }
                );
            } catch (error) {
                console.error("Error setting up members listener:", error);
                memberSelector.innerHTML = '<option value="">Error: ' + error.message + '</option>';
            }
        }

        function updateMembersSelector(data) {
            // Clear previous options except the default one
            while (memberSelector.options.length > 1) {
                memberSelector.remove(1);
            }

            if (!data) {
                return;
            }

            // Sort members by ID
            const sortedMembers = Object.keys(data).sort((a, b) => parseInt(a) - parseInt(b));

            sortedMembers.forEach(memberId => {
                const member = data[memberId];
                const option = document.createElement('option');
                option.value = memberId;
                option.textContent = `${memberId}: ${member.Name || 'Unknown'}`;
                memberSelector.appendChild(option);
            });

            // If a member was previously selected, maintain the selection and update details
            if (memberSelector.value) {
                setupMemberDetailsListener(memberSelector.value);
            }
        }

        function setupMemberDetailsListener(memberId) {
            // Check if Firebase is initialized
            if (!db) {
                memberDetails.innerHTML = '<div class="no-data">Firebase not initialized. Please refresh the page and try again.</div>';
                return;
            }
            
            memberDetails.innerHTML = '<div class="loading">Loading member details...</div>';

            // Remove previous listeners if any
            if (activeMemberListener) {
                activeMemberListener();
                activeMemberListener = null;
            }
            if (activePaymentListener) {
                activePaymentListener();
                activePaymentListener = null;
            }

            try {
                // Reference to the specific user
                const userRef = db.ref(`Users/${memberId}`);
                const paymentRef = db.ref(`paymentTable/${memberId}`);

                // Set up real-time listeners with safe error handling
                activeMemberListener = userRef.on('value', 
                    (userSnapshot) => {
                        if (userSnapshot) {
                            const userData = userSnapshot.val();
                            
                            if (!userData) {
                                memberDetails.innerHTML = '<div class="no-data">Member not found.</div>';
                                return;
                            }

                            // The payment listener will trigger the UI update when both user and payment data are available
                            if (!activePaymentListener) {
                                activePaymentListener = paymentRef.on('value', 
                                    (paymentSnapshot) => {
                                        if (paymentSnapshot) {
                                            const paymentData = paymentSnapshot.val() || {};
                                            updateMemberDetailsDisplay(memberId, userData, paymentData);
                                        } else {
                                            updateMemberDetailsDisplay(memberId, userData, {});
                                        }
                                    }, 
                                    (error) => {
                                        console.error("Error loading payment data:", error);
                                        // Still update the display with user data only
                                        updateMemberDetailsDisplay(memberId, userData, {});
                                    }
                                );
                            }
                        } else {
                            memberDetails.innerHTML = '<div class="no-data">Unable to retrieve member data.</div>';
                        }
                    }, 
                    (error) => {
                        console.error("Error loading member details:", error);
                        memberDetails.innerHTML = `<div class="no-data">Error loading member details: ${error.message}</div>`;
                    }
                );
            } catch (error) {
                console.error("Error setting up member details listener:", error);
                memberDetails.innerHTML = `<div class="no-data">Error setting up data listener: ${error.message}</div>`;
            }
        }

        function updateMemberDetailsDisplay(memberId, userData, paymentData) {
            // Format user details
            const statusClass = (userData.Payment_Status || '').toLowerCase() === 'paid' ? 'status-paid' : 'status-unpaid';

            let html = `
                <div class="user-detail">
                    <h3>Member Details</h3>
                    <div class="user-info">
                        <div class="info-item">
                            <div class="info-label">Member ID</div>
                            <div class="info-value">${memberId}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Gym ID</div>
                            <div class="info-value">${userData.Gym_ID || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Name</div>
                            <div class="info-value">${userData.Name || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Age</div>
                            <div class="info-value">${userData.Age || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Address</div>
                            <div class="info-value">${userData.Address || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Payment Status</div>
                            <div class="info-value">
                                <span class="payment-status ${statusClass}">${userData.Payment_Status || 'N/A'}</span>
                            </div>
                            
                        </div>
                        <div class="info-item">
                            <div class="info-label">Phone Number</div>
                            <div class="info-value">${userData.Phone_Number || 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="makePaymentBtn" data-id="${memberId}">Make Payment</button>
                        
                        <button id="editMemberBtn" data-id="${memberId}">Edit Details</button>
                    </div>
                </div>
            `;

            // Add payment history section if payment data exists
            /*
            if (paymentData && Object.keys(paymentData).length > 0) {
                html += `
                    <div class="payment-history">
                        <h4>Payment History</h4>
                        <table class="attendance-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Sort payment entries by date (newest first)
                const sortedPayments = Object.keys(paymentData)
                    .sort((a, b) => new Date(b) - new Date(a));

                sortedPayments.forEach(date => {
                    const payment = paymentData[date];
                    const statusClass = (payment.Status || '').toLowerCase() === 'paid' ? 'status-paid' : 'status-unpaid';

                    html += `
                        <tr>
                            <td>${formatDate(date)}</td>
                            <td>${payment.Amount || 'N/A'}</td>
                            <td><span class="payment-status ${statusClass}">${payment.Status || 'N/A'}</span></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += `
                    <div class="payment-history">
                        <h4>Payment History</h4>
                        <div class="no-data">No payment history available</div>
                    </div>
                `;
            }
*/
            memberDetails.innerHTML = html;

            // Attach event listeners to new buttons
            document.getElementById('makePaymentBtn').addEventListener('click', function() {
                openPaymentModal(memberId);
            });

            document.getElementById('editMemberBtn').addEventListener('click', function() {
                openEditMemberModal(memberId, userData);
            });
        }

        function openPaymentModal(memberId) {
            // Store the member ID for use in the confirmation function
            confirmPaymentBtn.setAttribute('data-id', memberId);
            // Display the modal
            paymentModal.style.display = 'flex';
        }

        function processPayment() {
            const memberId = confirmPaymentBtn.getAttribute('data-id');
            
            if (!db || !memberId) {
                alert('Error: Cannot process payment at this time.');
                paymentModal.style.display = 'none';
                return;
            }

            // Current date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            
            // Update user payment status in User table
            const userRef = db.ref(`Users/${memberId}`);
            userRef.update({
                Payment_Status: 'Paid',
                Last_Payment_Date: today
            })
            .then(() => {
                // Record payment in paymentTable
                const paymentRef = db.ref(`paymentTable/${memberId}/${today}`);
                return paymentRef.set({
                    Date: today,
                    Amount: '500',  // Default amount, could be made configurable
                    Status: 'Paid'
                });
            })
            .then(() => {
                // Close modal when done
                paymentModal.style.display = 'none';
                // Show success message
                alert('Payment recorded successfully!');
            })
            .catch(error => {
                console.error("Error recording payment:", error);
                alert('Error recording payment: ' + error.message);
                paymentModal.style.display = 'none';
            });
        }

        function openEditMemberModal(memberId, userData) {
            // Clear the form first
            editMemberForm.innerHTML = '';
            
            // Create form fields based on user data
            const fields = [
                { id: 'name', label: 'Name', value: userData.Name || '' },
                { id: 'gymId', label: 'Gym ID', value: userData.Gym_ID || '' },
                { id: 'age', label: 'Age', value: userData.Age || '' },
                { id: 'address', label: 'Address', value: userData.Address || '' },
                { id: 'phoneNumber', label: 'Phone Number', value: userData.Phone_Number || '' }
            ];
            
            fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.htmlFor = field.id;
                label.textContent = field.label;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.id = field.id;
                input.value = field.value;
                input.name = field.id;
                
                formGroup.appendChild(label);
                formGroup.appendChild(input);
                editMemberForm.appendChild(formGroup);
            });
            
            // Store member ID for use in save function
            saveChangesBtn.setAttribute('data-id', memberId);
            
            // Display the modal
            editMemberModal.style.display = 'flex';
        }

        function saveUserChanges() {
            const memberId = saveChangesBtn.getAttribute('data-id');
            
            if (!db || !memberId) {
                alert('Error: Cannot save changes at this time.');
                editMemberModal.style.display = 'none';
                return;
            }
            
            // Get updated values from the form
            const updatedData = {
                Name: document.getElementById('name').value,
                Gym_ID: document.getElementById('gymId').value,
                Age: document.getElementById('age').value,
                Address: document.getElementById('address').value,
                Phone_Number: document.getElementById('phoneNumber').value
            };
            
            // Update user data in Firebase
            const userRef = db.ref(`Users/${memberId}`);
            userRef.update(updatedData)
                .then(() => {
                    // Close modal when done
                    editMemberModal.style.display = 'none';
                    // Show success message
                    alert('Member details updated successfully!');
                })
                .catch(error => {
                    console.error("Error updating member details:", error);
                    alert('Error updating member details: ' + error.message);
                    editMemberModal.style.display = 'none';
                });
        }

        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            } catch (e) {
                return dateString; // Return original if format is unexpected
            }
        }

        // Initialize tabs
        document.addEventListener('DOMContentLoaded', function() {
            // Set the first tab as active
            if (tabs.length > 0) {
                tabs[0].click();
            }
        });
    </script>
</body>
</html>
